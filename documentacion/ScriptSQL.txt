-- 0) (Opcional) Borrar esquema previo
DROP DATABASE IF EXISTS gestion_plantillas;
CREATE DATABASE gestion_plantillas
  CHARACTER SET utf8mb4
  COLLATE utf8mb4_unicode_ci;
USE gestion_plantillas;

-- 1) Tabla Empresa (ahora con contraseña)
CREATE TABLE empresa (
  id_empresa     INT AUTO_INCREMENT PRIMARY KEY,
  nombre         VARCHAR(100) NOT NULL,
  direccion      VARCHAR(200),
  telefono       VARCHAR(20),
  email          VARCHAR(100),
  password_hash  VARCHAR(255) NOT NULL
) ENGINE=InnoDB;

-- 2) Única tabla: Empleado (incluye datos de usuario + empleado)
CREATE TABLE empleado (
  id_usuario     INT AUTO_INCREMENT PRIMARY KEY,
  id_empresa     INT         NOT NULL,
  nombre         VARCHAR(100) NOT NULL,
  apellidos      VARCHAR(100) NOT NULL,
  departamento   VARCHAR(100),
  telefono       VARCHAR(20)  NOT NULL UNIQUE,
  email          VARCHAR(100) NOT NULL UNIQUE,
  password_hash  VARCHAR(255) NOT NULL,
  activo         BOOLEAN      NOT NULL DEFAULT TRUE,
  puesto         VARCHAR(100),
  FOREIGN KEY (id_empresa)
    REFERENCES empresa(id_empresa)
    ON DELETE RESTRICT
) ENGINE=InnoDB;

-- 3) Relación reflexiva: supervisión entre empleados
CREATE TABLE supervisa (
  id_encargado INT NOT NULL,
  id_empleado  INT NOT NULL,
  PRIMARY KEY (id_encargado, id_empleado),
  FOREIGN KEY (id_encargado)
    REFERENCES empleado(id_usuario)
    ON DELETE CASCADE,
  FOREIGN KEY (id_empleado)
    REFERENCES empleado(id_usuario)
    ON DELETE CASCADE
) ENGINE=InnoDB;

-- 4) Turnos
CREATE TABLE turno (
  id_turno     INT AUTO_INCREMENT PRIMARY KEY,
  descripcion  VARCHAR(100) NOT NULL,
  hora_inicio  TIME         NOT NULL,
  hora_fin     TIME         NOT NULL,
  id_creador   INT          NULL,
  FOREIGN KEY (id_creador)
    REFERENCES empleado(id_usuario)
    ON DELETE SET NULL
) ENGINE=InnoDB;

-- 5) Ausencias
CREATE TABLE ausencia (
  id_ausencia     INT AUTO_INCREMENT PRIMARY KEY,
  id_empleado     INT         NOT NULL,
  id_encargado    INT         NULL,
  fecha_solicitud DATETIME    NOT NULL DEFAULT CURRENT_TIMESTAMP,
  fecha_inicio    DATE        NOT NULL,
  fecha_fin       DATE        NOT NULL,
  estado          ENUM('pendiente','aprobada','rechazada') NOT NULL DEFAULT 'pendiente',
  motivo          VARCHAR(100),
  FOREIGN KEY (id_empleado)
    REFERENCES empleado(id_usuario)
    ON DELETE CASCADE,
  FOREIGN KEY (id_encargado)
    REFERENCES empleado(id_usuario)
    ON DELETE SET NULL
) ENGINE=InnoDB;

-- 6) Asignación de turnos
CREATE TABLE pertenece (
  id_empleado INT NOT NULL,
  id_turno    INT NOT NULL,
  fecha       DATE NOT NULL,
  PRIMARY KEY (id_empleado, id_turno, fecha),
  FOREIGN KEY (id_empleado)
    REFERENCES empleado(id_usuario)
    ON DELETE CASCADE,
  FOREIGN KEY (id_turno)
    REFERENCES turno(id_turno)
    ON DELETE CASCADE
) ENGINE=InnoDB;